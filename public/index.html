<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <title>Phone Racing Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#7A74CE">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Rubik', Arial, sans-serif;
            background: #7A74CE;
            color: white;
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height */
            overflow: hidden;
            
            /* Force landscape orientation display */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            
            /* Hide address bar */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .container {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            
            /* Landscape layout */
            width: 100%;
            max-width: 800px;
            max-height: 400px;
            display: grid;
            grid-template-columns: 1fr 300px 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .header {
            grid-column: 1 / -1;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .left-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .center-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .right-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        button {
            font-size: 16px;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            background: #F9AC7E;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(249, 172, 126, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .token-display {
            background: #3F469D;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 250px;
        }

        .token-value {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 2px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 8px;
        }

        .values {
            background: #3F469D;
            padding: 15px;
            border-radius: 15px;
            display: none;
            min-width: 200px;
        }

        .values h3 {
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
        }

        .value-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }

        .value {
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            min-width: 60px;
        }

        .value-label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .value-number {
            font-size: 16px;
            font-weight: normal;
        }

        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .instructions {
            grid-column: 1 / -1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.4;
            text-align: center;
        }

        .connection-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ff4444;
            transition: all 0.3s ease;
        }

        .connection-indicator.connected {
            background: #44ff44;
        }

        .orientation-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #7A74CE;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 1000;
            padding: 30px 20px;
        }

        .orientation-warning.show {
            display: flex;
        }

        .phone-demo {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            font-size: 50px;
        }

        .hand-left, .hand-right {
            font-size: 40px;
        }

        .arrow {
            font-size: 30px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .steps {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            max-width: 600px;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            font-size: 16px;
        }

        .step-number {
            background: #F9AC7E;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .flip-toggle {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .switch.active {
            background: #F9AC7E;
        }

        .switch-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .switch.active .switch-slider {
            transform: translateX(30px);
        }

        /* Show orientation warning in portrait mode */
        @media (orientation: portrait) {
            .orientation-warning {
                display: flex;
            }
            .container {
                display: none;
            }
        }

        .steering-wheel {
            font-size: 60px;
            margin: 10px 0;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="orientation-warning">
        <div class="rotate-icon">üì±‚û°Ô∏èüì±</div>
        <h2>–ó–∞–≤—ä—Ä—Ç–µ—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞!</h2>
        <p>–î—ä—Ä–∂–µ—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Ö–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–Ω–æ –∫–∞—Ç–æ –≤–æ–ª–∞–Ω<br>
        –ö–∞–º–µ—Ä–∞—Ç–∞ –≤ –ª—è–≤–∞—Ç–∞ —Ä—ä–∫–∞, –∑–∞—Ä—è–¥–Ω–æ—Ç–æ –≤ –¥—è—Å–Ω–∞—Ç–∞ —Ä—ä–∫–∞</p>
        <div class="steering-wheel">üèéÔ∏è</div>
    </div>

    <div class="connection-indicator" id="connectionIndicator"></div>
    
    <div class="container">
        <div class="header">
            <h1>üèéÔ∏è Racing Controller</h1>
            <div class="subtitle">–£–ø—Ä–∞–≤–ª—è–≤–∞–π—Ç–µ –∏–≥—Ä–∞—Ç–∞ –∫–∞—Ç–æ –≤–æ–ª–∞–Ω –Ω–∞ –∫–æ–ª–∞</div>
        </div>

        <div class="left-controls">
            <button id="connect">üîó –°–≤—ä—Ä–∂–∏ —Å–µ</button>
            <div class="steering-wheel">üéÆ</div>
        </div>

        <div class="center-status">
            <div class="token-display">
                <div>–ö–æ–¥ –∑–∞ –≤—Ä—ä–∑–∫–∞:</div>
                <div class="token-value" id="token">–ù—è–º–∞ –≤—Ä—ä–∑–∫–∞</div>
            </div>

            <div class="values" id="values">
                <h3>üèÅ –î–∞–Ω–Ω–∏ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                <div class="value-row">
                    <div class="value">
                        <div class="value-label">üèéÔ∏è –í–æ–ª–∞–Ω (X)</div>
                        <div class="value-number" id="x">0.0</div>
                    </div>
                    <div class="value">
                        <div class="value-label">‚ö° –ì–∞–∑/–°–ø–∏—Ä–∞—á–∫–∞ (Z)</div>
                        <div class="value-number" id="y">0.0</div>
                    </div>
                </div>
                <div class="status" id="status">–ì–æ—Ç–æ–≤ –∑–∞ —à–æ—Ñ–∏—Ä–∞–Ω–µ...</div>
            </div>
        </div>

        <div class="right-controls">
            <div style="text-align: center; font-size: 14px; opacity: 0.8;">
                <div>üì∑ –ö–∞–º–µ—Ä–∞</div>
                <div>‚¨ÖÔ∏è –õ—è–≤–∞ —Ä—ä–∫–∞</div>
                <div style="margin: 10px 0;">VS</div>
                <div>üîå –ó–∞—Ä—è–¥–Ω–æ</div>
                <div>‚û°Ô∏è –î—è—Å–Ω–∞ —Ä—ä–∫–∞</div>
            </div>
        </div>

        <div class="instructions">
            üèéÔ∏è <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞ —à–æ—Ñ–∏—Ä–∞–Ω–µ:</strong><br>
            1. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ "–°–≤—ä—Ä–∂–∏ —Å–µ" –∏ —Ä–∞–∑—Ä–µ—à–µ—Ç–µ –¥–æ—Å—Ç—ä–ø –¥–æ —Å–µ–Ω–∑–æ—Ä–∏—Ç–µ<br>
            2. –î—Ä—ä–∂—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å—Ç–∞–±–∏–ª–Ω–æ –∑–∞ –∫—Ä–∞—Ç–∫–æ –∫–∞–ª–∏–±—Ä–∏—Ä–∞–Ω–µ<br>
            3. –í—ä–≤–µ–¥–µ—Ç–µ –∫–æ–¥–∞ –≤ PictoBlox<br>
            4. –ù–∞–∫–ª–∞–Ω—è–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–∞—Ç–æ –≤–æ–ª–∞–Ω: –ª—è–≤–æ/–¥—è—Å–Ω–æ –∑–∞ –∑–∞–≤–∏–≤–∞–Ω–µ, –Ω–∞–ø—Ä–µ–¥/–Ω–∞–∑–∞–¥ –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç
        </div>
    </div>

    <script>
        // Core variables
        let token = '';
        let connected = false;
        let velocityX = 0;
        let velocityY = 0;
        let calibrationSamples = [];
        let restPositionX = 0;
        let restPositionY = 0;

        // DOM elements
        const connectButton = document.getElementById('connect');
        const tokenElement = document.getElementById('token');
        const valuesElement = document.getElementById('values');
        const xElement = document.getElementById('x');
        const yElement = document.getElementById('y');
        const statusElement = document.getElementById('status');
        const connectionIndicator = document.getElementById('connectionIndicator');

        // Update status and connection indicator
        function updateStatus(message, type = 'info') {
            statusElement.textContent = message;
            connectionIndicator.classList.toggle('connected', type === 'success');
        }

        // Connect button handler
        connectButton.onclick = async () => {
            connectButton.disabled = true;
            connectButton.textContent = '–°–≤—ä—Ä–∑–≤–∞–Ω–µ...';

            try {
                // Get session token
                const response = await fetch('/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                
                const data = await response.json();
                if (!data.token) throw new Error('No token received');

                token = data.token;
                tokenElement.textContent = token;

                // Request motion sensor permission
                console.log('üì± Requesting motion sensor permission...');
                if (typeof DeviceMotionEvent !== 'undefined' && 
                    typeof DeviceMotionEvent.requestPermission === 'function') {
                    const permission = await DeviceMotionEvent.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('Motion sensor permission denied');
                    }
                    console.log('‚úÖ Motion permission granted');
                }

                // Start motion tracking
                window.addEventListener('devicemotion', handleMotion, { passive: true });

                // Update UI
                connected = true;
                valuesElement.style.display = 'block';
                connectButton.textContent = '‚úÖ –°–≤—ä—Ä–∑–∞–Ω';
                connectButton.style.background = '#6CC5A1';
                updateStatus('–ì–æ—Ç–æ–≤ –∑–∞ —à–æ—Ñ–∏—Ä–∞–Ω–µ! –ù–∞–∫–ª–∞–Ω—è–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.', 'success');

            } catch (error) {
                connectButton.disabled = false;
                connectButton.textContent = 'üîó –°–≤—ä—Ä–∂–∏ —Å–µ';
                connectButton.style.background = '#F9AC7E';
                tokenElement.textContent = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ';
                updateStatus(`–ì—Ä–µ—à–∫–∞: ${error.message}`, 'error');
                alert(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ: ${error.message}`);
            }
        };

        // Global flip setting
        let isFlipped = false;

        // Flip toggle functionality
        document.getElementById('flipToggle').onclick = function() {
            isFlipped = !isFlipped;
            this.classList.toggle('active', isFlipped);
            console.log('üì± Flip mode:', isFlipped ? 'ON' : 'OFF');
        };

        // Hide address bar on mobile
        function hideAddressBar() {
            // Scroll to hide address bar
            setTimeout(() => {
                window.scrollTo(0, 1);
            }, 100);
            
            // Force viewport update
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // FIXED: Use Z-axis for throttle to avoid Y-axis gravity issues
        function handleMotion(event) {
            if (!connected || !token) return;

            const accel = event.accelerationIncludingGravity || {};
            
            // Get raw values - using Z-axis for throttle to avoid Y-axis issues
            let rawSteering, rawThrottle;
            
            if (isFlipped) {
                // Flipped mode: camera on right, charging port on left
                rawSteering = -(parseFloat(accel.x) || 0);  // X-axis for steering (inverted)
                rawThrottle = parseFloat(accel.z) || 0;     // Z-axis for throttle
            } else {
                // Normal mode: camera on left, charging port on right
                rawSteering = parseFloat(accel.x) || 0;     // X-axis for steering
                rawThrottle = parseFloat(accel.z) || 0;     // Z-axis for throttle
            }

            // Debug: log raw values to understand what we're getting
            if (calibrationSamples.length >= 30 && Date.now() % 1000 < 50) {
                console.log('üìä Raw sensors:', {
                    X: (parseFloat(accel.x) || 0).toFixed(2),
                    Y: (parseFloat(accel.y) || 0).toFixed(2),
                    Z: (parseFloat(accel.z) || 0).toFixed(2),
                    'Using Steering': rawSteering.toFixed(2),
                    'Using Throttle': rawThrottle.toFixed(2)
                });
            }

            // Quick calibration (first 50 samples for better baseline)
            if (calibrationSamples.length < 50) {
                calibrationSamples.push({ steering: rawSteering, throttle: rawThrottle });
                if (calibrationSamples.length === 50) {
                    restPositionX = calibrationSamples.reduce((sum, s) => sum + s.steering, 0) / 50;
                    restPositionY = calibrationSamples.reduce((sum, s) => sum + s.throttle, 0) / 50;
                    updateStatus('–ö–∞–ª–∏–±—Ä–∏—Ä–∞–Ω–µ –∑–∞–≤—ä—Ä—à–µ–Ω–æ - –≥–æ—Ç–æ–≤ –∑–∞ —à–æ—Ñ–∏—Ä–∞–Ω–µ!', 'success');
                    console.log('üéØ Calibration complete:', { 
                        restSteering: restPositionX.toFixed(2), 
                        restThrottle: restPositionY.toFixed(2) 
                    });
                } else {
                    updateStatus(`–ö–∞–ª–∏–±—Ä–∏—Ä–∞–Ω–µ... ${calibrationSamples.length}/50`, 'info');
                }
                return;
            }

            // Calculate tilt from neutral position
            const steeringTilt = rawSteering - restPositionX;
            const throttleTilt = rawThrottle - restPositionY;

            // Larger dead zone for more stable control
            const deadZone = 2.0;
            
            let processedSteering = Math.abs(steeringTilt) > deadZone ? steeringTilt : 0;
            let processedThrottle = Math.abs(throttleTilt) > deadZone ? throttleTilt : 0;

            // Convert to movement values with conservative multiplier
            const multiplier = 1.0;
            velocityX = Math.max(-6, Math.min(6, processedSteering * multiplier));   // Steering
            velocityY = Math.max(-6, Math.min(6, processedThrottle * multiplier));  // Throttle

            // Update display with debug info
            xElement.textContent = `${velocityX.toFixed(1)} (${steeringTilt.toFixed(1)})`;
            yElement.textContent = `${velocityY.toFixed(1)} (${throttleTilt.toFixed(1)})`;

            // Send to server
            sendUpdate(velocityX, velocityY);
        }

        // Send motion data to server
        async function sendUpdate(x, y) {
            try {
                const response = await fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, x, y })
                });

                if (!response.ok) {
                    updateStatus('–ü—Ä–æ–±–ª–µ–º —Å –≤—Ä—ä–∑–∫–∞—Ç–∞...', 'error');
                }
            } catch (error) {
                updateStatus('–í—Ä—ä–∑–∫–∞—Ç–∞ –µ –∑–∞–≥—É–±–µ–Ω–∞...', 'error');
            }
        }

        // Initialize
        updateStatus('–ó–∞–≤—ä—Ä—Ç–µ—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ "–°–≤—ä—Ä–∂–∏ —Å–µ"', 'info');

        // Force landscape orientation check
        function checkOrientation() {
            const orientationWarning = document.querySelector('.orientation-warning');
            const container = document.querySelector('.container');
            
            if (window.innerWidth < window.innerHeight) {
                // Portrait mode - show warning
                orientationWarning.classList.add('show');
                container.style.display = 'none';
            } else {
                // Landscape mode - show app
                orientationWarning.classList.remove('show');
                container.style.display = 'grid';
            }
        }

        // Check orientation on load and resize
        window.addEventListener('load', () => {
            checkOrientation();
            hideAddressBar();
        });
        window.addEventListener('resize', () => {
            checkOrientation();
            hideAddressBar();
        });
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                checkOrientation();
                hideAddressBar();
            }, 200);
        });

        // Additional mobile browser optimizations
        window.addEventListener('scroll', hideAddressBar);
        document.addEventListener('touchstart', hideAddressBar, { passive: true });
    </script>
</body>
</html>
