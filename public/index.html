<!DOCTYPE html>
<html>
<head>
    <title>IoT Motion Game</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        button { font-size: 18px; padding: 10px 20px; }
        #token { font-weight: bold; }
    </style>
</head>
<body>
    <h1>IoT Motion Game</h1>
    <p>Click below to start and get your token:</p>
    <button id="start">Start & Connect</button>
    <p>Your token: <span id="token">-</span></p>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded'); // Debug step 1
            let token = '';

            const startButton = document.getElementById('start');
            if (startButton) {
                console.log('Start button found'); // Debug step 2
                startButton.onclick = async () => {
                    console.log('Button clicked'); // Debug step 3
                    alert('Initiating connection...');
                    try {
                        const res = await fetch('/start', {
                            method: 'POST',
                            mode: 'cors' // Explicitly set CORS mode
                        });
                        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                        const data = await res.json();
                        console.log('Fetch response:', data); // Debug step 4
                        alert(`Fetch succeeded, data: ${JSON.stringify(data)}`);
                        token = data.token;
                        document.getElementById('token').innerText = token;
                        alert(`Token set to: ${token}`);

                        // Setup motion listener
                        if (typeof DeviceMotionEvent !== 'undefined' && DeviceMotionEvent.requestPermission) {
                            try {
                                const permissionState = await DeviceMotionEvent.requestPermission();
                                if (permissionState === 'granted') {
                                    window.addEventListener('devicemotion', handleMotion);
                                } else {
                                    alert('Motion sensor permission denied. Please allow access in browser settings.');
                                }
                            } catch (error) {
                                alert('Error requesting permission: ' + error);
                                window.addEventListener('devicemotion', handleMotion); // Fallback
                            }
                        } else {
                            window.addEventListener('devicemotion', handleMotion); // For browsers without prompt
                        }
                    } catch (error) {
                        console.error('Fetch error:', error); // Debug step 5
                        alert(`Error: ${error.message}`);
                    }
                };
            } else {
                console.error('Start button not found in DOM'); // Debug step 6
                alert('Error: Start button not found!');
            }

            // Fallback to check server status
            fetch('/').then(res => {
                console.log('Server status check:', res.status);
            }).catch(err => {
                console.error('Server unreachable:', err);
            });
        });

        function handleMotion(e) {
            const accel = e.accelerationIncludingGravity || e.acceleration || {};
            const x = accel.x || 0;
            const y = accel.y || 0;
            alert(`Motion detected: x=${x}, y=${y}`);
            if (x === 0 && y === 0) {
                console.log('Full event data:', e);
            }
            try {
                const response = await fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, x, y })
                });
                const result = await response.json();
                console.log('Update response:', result);
            } catch (error) {
                alert(`Fetch error: ${error}`);
            }
        }
    </script>
</body>
</html>
