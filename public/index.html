<!DOCTYPE html>
<html>
<head>
    <title>IoT Motion Game</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        button { font-size: 18px; padding: 10px 20px; }
        #token { font-weight: bold; }
    </style>
</head>
<body>
    <h1>IoT Motion Game</h1>
    <p>Click below to start and get your token:</p>
    <button id="start">Start & Connect</button>
    <p>Your token: <span id="token">-</span></p>
    <script>
        let token = '';

        document.getElementById('start').onclick = async () => {
            alert('Button clicked, initiating connection...'); // Debug step 1
            try {
                const res = await fetch('/start', { method: 'POST' });
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                alert(`Fetch succeeded, data: ${JSON.stringify(data)}`); // Debug step 2
                token = data.token;
                document.getElementById('token').innerText = token;
                alert(`Token set to: ${token}`); // Debug step 3

                // Setup motion listener after token is received
                if (typeof DeviceMotionEvent !== 'undefined' && DeviceMotionEvent.requestPermission) {
                    try {
                        const permissionState = await DeviceMotionEvent.requestPermission();
                        if (permissionState === 'granted') {
                            window.addEventListener('devicemotion', handleMotion);
                        } else {
                            alert('Motion sensor permission denied. Please allow access in browser settings.');
                        }
                    } catch (error) {
                        alert('Error requesting permission: ' + error);
                        window.addEventListener('devicemotion', handleMotion); // Fallback
                    }
                } else {
                    window.addEventListener('devicemotion', handleMotion); // For browsers without prompt
                }
            } catch (error) {
                alert(`Error: ${error.message}`); // Debug step 4
            }
        };

        function handleMotion(e) {
            const accel = e.accelerationIncludingGravity || e.acceleration || {};
            const x = accel.x || 0;
            const y = accel.y || 0;
            alert(`Motion detected: x=${x}, y=${y}`);
            if (x === 0 && y === 0) {
                console.log('Full event data:', e);
            }
            try {
                const response = await fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, x, y })
                });
                const result = await response.json();
                console.log('Update response:', result);
            } catch (error) {
                alert(`Fetch error: ${error}`);
            }
        }
    </script>
</body>
</html>
